{% extends "base.html" %}
{% block content %}
<div class="row justify-content-center">
    <div class="col-lg-10 col-12">
        <h2 class="mb-4 text-center text-md-start">Inventario Físico por Tienda</h2>
        {% if mensaje %}
            <div class="alert alert-success text-center">{{ mensaje }}</div>
        {% endif %}
        <form method="post">
            <div class="mb-3">
                <label for="tienda" class="form-label">Selecciona la Tienda</label>
                <select id="tienda" name="tienda" class="form-select" required>
                    {% for tienda in tiendas %}
                        <option value="{{ tienda }}">{{ tienda }}</option>
                    {% endfor %}
                </select>
            </div>
            <!-- Campo para escanear código de barras -->
            <div class="mb-3">
                <input id="scanner" type="text" class="form-control" placeholder="Escanea un código de barras aquí..." autofocus autocomplete="off">
            </div>
            <div class="table-responsive mb-4" style="max-height:500px; overflow:auto;">
                <div class="mb-3">
                    <input id="buscador" type="text" class="form-control" placeholder="Buscar por Código, Descripción o Código de Barras...">
                </div>
                <table class="table table-bordered table-striped align-middle">
                    <thead class="table-dark">
                        <tr>
                            <th>COD. ARTÍCULO</th>
                            <th>DESCRIPCIÓN</th>
                            <th>COD. BARRAS</th>
                            <th>Cantidad Física</th>
                        </tr>
                    </thead>
                    <tbody>
                    {% for p in productos %}
                        <tr data-codbarras="{{ p['cod_barras'] }}">
                            <td>{{ p['codigo'] }}</td>
                            <td>{{ p['descripcion'] }}</td>
                            <td>{{ p['cod_barras'] }}</td>
                            <td>
                                <input type="number" min="0" class="form-control" name="stock_{{ p['codigo'] }}" placeholder="Cantidad">
                            </td>
                        </tr>
                    {% endfor %}
                    </tbody>
                </table>
            </div>
            <div class="d-grid">
                <button type="button" class="btn btn-primary" id="btnGuardarInventario">Guardar Inventario Físico</button>
            </div>
        </form>
        <hr>
        <div class="alert alert-info mt-4">
            <strong>¿Cómo funciona?</strong>
            <ul class="mb-0">
                <li><b>Cada vez que completes y guardes este formulario, se crea un nuevo recuento histórico</b> para cada producto contado en la tienda seleccionada.</li>
                <li><b>No se borran conteos anteriores:</b> puedes consultar el histórico completo en la pestaña <a href="{{ url_for('conteos_fisicos') }}">Conteos en Tienda</a>.</li>
                <li><b>Puedes sumar productos rápidamente con el escáner de código de barras.</b></li>
            </ul>
        </div>
    </div>
</div>

<!-- Modal para pedir el nombre del autor del inventario -->
<div class="modal fade" id="modalAutor" tabindex="-1" aria-labelledby="modalAutorLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="modalAutorLabel">Guardar inventario</h5>
      </div>
      <div class="modal-body">
        <div class="mb-3">
          <label for="inputAutor" class="form-label">¿Quién realiza este inventario?</label>
          <input type="text" class="form-control" id="inputAutor" placeholder="Tu nombre" required>
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
        <button type="button" class="btn btn-primary" id="btnAceptarAutor">Aceptar y guardar</button>
      </div>
    </div>
  </div>
</div>

<!-- Toast para mostrar confirmación del escaneo -->
<div class="position-fixed top-0 end-0 p-3" style="z-index: 1100">
    <div id="toastScanOK" class="toast align-items-center text-bg-success border-0" role="alert" aria-live="assertive" aria-atomic="true">
        <div class="d-flex">
            <div class="toast-body">
                <i class="bi bi-upc-scan"></i> ¡Producto sumado!
            </div>
            <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="Close"></button>
        </div>
    </div>
</div>

<script>
document.addEventListener("DOMContentLoaded", function() {
    // Buscador
    const input = document.getElementById("buscador");
    if(input){
        input.addEventListener("keyup", function() {
            const filter = input.value.toLowerCase();
            const rows = document.querySelectorAll("table tbody tr");
            rows.forEach(function(row) {
                const codigo = row.children[0].innerText.toLowerCase();
                const descripcion = row.children[1].innerText.toLowerCase();
                const cod_barras = row.children[2].innerText.toLowerCase();
                if (
                    codigo.includes(filter) ||
                    descripcion.includes(filter) ||
                    cod_barras.includes(filter)
                ) {
                    row.style.display = "";
                } else {
                    row.style.display = "none";
                }
            });
        });
    }

    // Nuevo: Escaneo con aviso
    const scannerInput = document.getElementById("scanner");
    scannerInput.addEventListener("keydown", function(e) {
        if (e.key === "Enter") {
            e.preventDefault();
            const code = scannerInput.value.trim();
            if (!code) return;
            let found = false;
            document.querySelectorAll("table tbody tr").forEach(function(row) {
                if (row.getAttribute("data-codbarras") === code) {
                    const inputCantidad = row.querySelector("input[type='number']");
                    let actual = parseInt(inputCantidad.value) || 0;
                    inputCantidad.value = actual + 1;
                    // Visual feedback
                    showScanToast();
                    // Opcional: selecciona el campo para que sea visible
                    inputCantidad.classList.add("table-success");
                    setTimeout(() => inputCantidad.classList.remove("table-success"), 600);
                    found = true;
                    // Desplaza la tabla a la fila encontrada (UX)
                    row.scrollIntoView({ behavior: "smooth", block: "center" });
                }
            });
            if (!found) {
                // Visual feedback si no se encuentra
                scannerInput.classList.add("is-invalid");
                setTimeout(() => scannerInput.classList.remove("is-invalid"), 900);
            }
            scannerInput.value = "";
        }
    });

    // Toast de Bootstrap 5 para feedback visual
    function showScanToast() {
        var toastEl = document.getElementById('toastScanOK');
        var toast = bootstrap.Toast.getOrCreateInstance(toastEl);
        toast.show();
    }

    // Modal para autor
    document.getElementById("btnGuardarInventario").onclick = function() {
        var modal = new bootstrap.Modal(document.getElementById('modalAutor'));
        modal.show();
    };
    document.getElementById("btnAceptarAutor").onclick = function() {
        var nombre = document.getElementById("inputAutor").value.trim();
        if (!nombre) {
            alert("Por favor, escribe tu nombre.");
            return;
        }
        let form = document.querySelector("form");
        let inputAutor = document.getElementById("autor-hidden");
        if (!inputAutor) {
            inputAutor = document.createElement("input");
            inputAutor.type = "hidden";
            inputAutor.name = "autor";
            inputAutor.id = "autor-hidden";
            form.appendChild(inputAutor);
        }
        inputAutor.value = nombre;
        form.submit();
    };
});
</script>

<style>
@media (max-width: 600px) {
    .row .col-lg-10 {
        padding-left: 5px;
        padding-right: 5px;
    }
    h2.mb-4 {
        font-size: 1.17rem;
    }
    .btn, .form-control, .form-select {
        font-size: 0.96rem !important;
    }
    .table-responsive {
        font-size: 0.93rem;
    }
}
</style>
{% endblock %}
