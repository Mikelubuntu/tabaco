{% extends "base.html" %}
{% block content %}
<div class="container mt-4">
    <h2>Conteos Físicos en Tienda Guardados <span style="font-size:0.7em;" class="text-muted">(Histórico completo)</span></h2>
    <div class="mb-3">
        <a href="{{ url_for('exportar_conteos_excel', tienda=tienda_seleccionada) }}" class="btn btn-success btn-sm mb-1">Descargar Excel</a>
        <a href="{{ url_for('exportar_conteos_pdf', tienda=tienda_seleccionada) }}" class="btn btn-danger btn-sm mb-1">Descargar PDF</a>
    </div>
    <p class="mb-3 text-muted">
        Cada registro corresponde a un recuento físico realizado en tienda. <br>
        Puedes filtrar por tienda, editar o eliminar conteos individuales, o borrar todos los históricos si lo deseas.
    </p>
    <form method="get" class="mb-3">
        <div class="row g-2 align-items-end">
            <div class="col-auto">
                <label for="tienda" class="form-label mb-0">Filtrar por tienda:</label>
            </div>
            <div class="col-8 col-sm-auto">
                <select name="tienda" id="tienda" class="form-select">
                    <option value="">Todas</option>
                    {% for tienda in tiendas %}
                        <option value="{{ tienda }}" {% if tienda == tienda_seleccionada %}selected{% endif %}>{{ tienda }}</option>
                    {% endfor %}
                </select>
            </div>
            <div class="col-auto">
                <button type="submit" class="btn btn-primary">Filtrar</button>
            </div>
        </div>
    </form>
    <div class="table-responsive">
        <table class="table table-bordered table-striped align-middle">
            <thead class="table-dark">
                <tr>
                    <th>Tienda</th>
                    <th>Fecha / Hora</th>
                    <th>COD. ARTÍCULO</th>
                    <th>DESCRIPCIÓN</th>
                    <th>COD. BARRAS</th>
                    <th>Cantidad Física</th>
                    <th>Acciones</th>
                </tr>
            </thead>
            <tbody>
                {% for c in conteos %}
                <tr>
                    <td>{{ c['tienda'] }}</td>
                    <td>
                        {{ c['fecha'][:19].replace('T',' ') if c['fecha'] else '-' }}
                    </td>
                    <td>{{ c['codigo'] }}</td>
                    <td>{{ c['descripcion'] }}</td>
                    <td>{{ c['cod_barras'] }}</td>
                    <td>{{ c['stock_fisico'] }}</td>
                    <td>
                        <!-- Editar -->
                        <a href="{{ url_for('editar_conteo', id=c['id']) }}" class="btn btn-warning btn-sm mb-1">Editar</a>
                        <!-- Eliminar individual -->
                        <form action="{{ url_for('eliminar_conteo', id=c['id']) }}" method="POST" style="display:inline;">
                            <button type="submit" class="btn btn-danger btn-sm mb-1" onclick="return confirm('¿Seguro que deseas eliminar este conteo?');">Eliminar</button>
                        </form>
                    </td>
                </tr>
                {% endfor %}
                {% if conteos|length == 0 %}
                <tr>
                    <td colspan="7" class="text-center">No hay registros para mostrar.</td>
                </tr>
                {% endif %}
            </tbody>
        </table>
    </div>
    <!-- Botón para borrar todos los conteos físicos -->
    <form method="POST" action="{{ url_for('eliminar_todos_conteos') }}" onsubmit="return confirm('¿Seguro que deseas borrar todos los conteos?');">
        <button type="submit" class="btn btn-danger mt-2 w-100 w-md-auto">Borrar todos los conteos</button>
    </form>
</div>
<style>
@media (max-width: 600px) {
    .container.mt-4 {
        padding-left: 4px;
        padding-right: 4px;
    }
    .table-responsive {
        font-size: 0.93rem;
    }
    .btn, .form-select, .form-control {
        font-size: 0.96rem !important;
    }
    h2 {
        font-size: 1.22rem;
        margin-bottom: 1rem !important;
        text-align: center;
    }
}
</style>
{% endblock %}
